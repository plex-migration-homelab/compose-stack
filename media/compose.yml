# Media Services - Plex and Jellyfin with Intel QuickSync hardware transcoding
# These services have direct WAN access for streaming to remote users

services:
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    network_mode: host
    restart: unless-stopped
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - VERSION=docker
      # Hardware transcoding
      - PLEX_CLAIM=${PLEX_CLAIM_TOKEN}
    volumes:
      # Plex configuration and metadata
      - ${APPDATA_PATH}/plex:/config:z
      # Media library (read-only from NFS)
      - /mnt/nas-media:/media:ro
      # Optional: transcode directory on fast local storage
      - ${APPDATA_PATH}/plex/transcode:/transcode:z
    devices:
      # Intel QuickSync hardware transcoding
      - /dev/dri:/dev/dri
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      # Hardware transcoding
      - LIBVA_DRIVER_NAME=iHD
      - JELLYFIN_PublishedServerUrl=${JELLYFIN_PUBLIC_URL}
    ports:
      - "8096:8096"   # HTTP
      - "8920:8920"   # HTTPS (optional)
      - "7359:7359/udp"  # Auto-discovery (optional)
    volumes:
      # Jellyfin configuration and metadata
      - ${APPDATA_PATH}/jellyfin/config:/config:z
      - ${APPDATA_PATH}/jellyfin/cache:/cache:z
      - ${APPDATA_PATH}/jellyfin/transcode:/transcode:z
      # Media library (read-only from NFS)
      - /mnt/nas-media:/media:ro
    devices:
      # Intel QuickSync hardware transcoding
      - /dev/dri:/dev/dri
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  komga:
    image: gotson/komga:latest
    container_name: komga
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/New_York}
      - KOMGA_LIBRARIES_SCAN_DIRECTORY_EXCLUSIONS=${KOMGA_LIBRARIES_SCAN_DIRECTORY_EXCLUSIONS:-#recycle,@eaDir}
    ports:
      - "25600:25600"
    volumes:
      # Komga configuration and database
      - ${APPDATA_PATH}/komga/config:/config:z
      # Media libraries (read-only from NFS)
      - /mnt/nas-media/ebooks:/books:ro
      - /mnt/nas-media/manga:/manga:ro
    networks:
      - media
    healthcheck:
      disable: true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  komga-kobo:
    image: gotson/komga:latest
    container_name: komga-kobo
    restart: unless-stopped
    environment:
      - TZ=${TZ:-America/New_York}
      - KOMGA_LIBRARIES_SCAN_DIRECTORY_EXCLUSIONS=${KOMGA_LIBRARIES_SCAN_DIRECTORY_EXCLUSIONS:-#recycle,@eaDir}
    ports:
      - "25601:25600"
    volumes:
      # Komga-kobo configuration and database
      - ${APPDATA_PATH}/komga-kobo/config:/config:z
      # Media libraries (read-only from NFS)
      - /mnt/nas-media/ebooks:/books:ro
      - /mnt/nas-media/ebooks/calibre library/calibre:/news:ro
    networks:
      - media
    healthcheck:
      disable: true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

# Networks are not needed for host network mode
# But we can define them for future services if needed
networks:
  media:
    name: media
    driver: bridge
