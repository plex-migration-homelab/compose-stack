services:
  nextcloud:
    image: lscr.io/linuxserver/nextcloud:latest
    container_name: nextcloud
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /var/lib/containers/appdata/nextcloud/config:/config
      - /var/lib/containers/appdata/nextcloud/data:/data
    ports:
      - "8080:80"
      - "8443:443"
    restart: unless-stopped
    depends_on:
      - nextcloud-db

  nextcloud-db:
    image: mariadb:10.11
    container_name: nextcloud-db
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - /var/lib/containers/appdata/nextcloud/db:/var/lib/mysql
    restart: unless-stopped

  immich:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DB_HOSTNAME=immich-db
      - DB_USERNAME=immich
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=immich-redis
    volumes:
      - /var/lib/containers/appdata/immich/upload:/usr/src/app/upload
      - /var/lib/containers/appdata/immich/library:/usr/src/app/library
    ports:
      - "2283:3001"
    restart: unless-stopped
    depends_on:
      - immich-db
      - immich-redis

  immich-db:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    container_name: immich-db
    environment:
      - POSTGRES_USER=immich
      - POSTGRES_PASSWORD=${IMMICH_DB_PASSWORD}
      - POSTGRES_DB=immich
    volumes:
      - /var/lib/containers/appdata/immich/db:/var/lib/postgresql/data
    restart: unless-stopped

  immich-redis:
    image: redis:7-alpine
    container_name: immich-redis
    restart: unless-stopped

  collabora:
    image: collabora/code:latest
    container_name: collabora
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - domain=${NEXTCLOUD_DOMAIN}
      - username=${COLLABORA_USERNAME}
      - password=${COLLABORA_PASSWORD}
      - extra_params=--o:ssl.enable=false
    ports:
      - "9980:9980"
    restart: unless-stopped
    cap_add:
      - MKNOD

networks:
  default:
    name: cloud_network
