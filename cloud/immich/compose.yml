version: '3.9'

# Immich Main Stack (Mini PC)
# This stack runs the main Immich services without the ML container
# The ML container runs separately on the fileserver with CUDA support

services:
  immich-server:
    container_name: immich_server
    image: ghcr.io/immich-app/immich-server:release
    restart: unless-stopped
    command: ['start.sh', 'immich']
    volumes:
      - ${UPLOAD_LOCATION}:/usr/src/app/upload:z
      - /etc/localtime:/etc/localtime:ro
    environment:
      # Database
      - DB_HOSTNAME=PostgreSQL_Immich
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE_NAME=${DB_DATABASE_NAME:-immich}

      # Redis
      - REDIS_HOSTNAME=immich_redis

      # Machine Learning - Points to remote ML server on fileserver
      - IMMICH_MACHINE_LEARNING_URL=${IMMICH_MACHINE_LEARNING_URL}

      # General
      - TZ=${TZ:-America/New_York}
      - LOG_LEVEL=${LOG_LEVEL:-log}
    ports:
      - 2283:3001
    depends_on:
      - redis
      - database
    networks:
      - immich

  immich-microservices:
    container_name: immich_microservices
    image: ghcr.io/immich-app/immich-server:release
    restart: unless-stopped
    command: ['start.sh', 'microservices']
    volumes:
      - ${UPLOAD_LOCATION}:/usr/src/app/upload:z
      - /etc/localtime:/etc/localtime:ro
    environment:
      # Database
      - DB_HOSTNAME=PostgreSQL_Immich
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE_NAME=${DB_DATABASE_NAME:-immich}

      # Redis
      - REDIS_HOSTNAME=immich_redis

      # Machine Learning - Points to remote ML server on fileserver
      - IMMICH_MACHINE_LEARNING_URL=${IMMICH_MACHINE_LEARNING_URL}

      # General
      - TZ=${TZ:-America/New_York}
      - LOG_LEVEL=${LOG_LEVEL:-log}
    depends_on:
      - redis
      - database
    networks:
      - immich

  redis:
    container_name: immich_redis
    image: redis:6.2-alpine
    restart: unless-stopped
    networks:
      - immich

  database:
    container_name: PostgreSQL_Immich
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_USER=${DB_USERNAME:-postgres}
      - POSTGRES_DB=${DB_DATABASE_NAME:-immich}
    volumes:
      - ${DB_DATA_LOCATION}:/var/lib/postgresql/data:z
    networks:
      - immich

networks:
  immich:
    name: immich
    driver: bridge

# Notes:
# 1. Set IMMICH_MACHINE_LEARNING_URL to point to your fileserver ML container
#    Example: http://192.168.1.100:3003
# 2. Ensure the fileserver ML container is accessible from this network
# 3. Upload location should be on fast storage (SSD preferred)
# 4. Database location should also be on reliable storage
# 5. Consider using NFS/network storage for uploads if you want shared access
